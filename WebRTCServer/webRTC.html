<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>WebRTC é€šä¿¡</title>
    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        padding: 16px;
        max-width: 600px;
        margin: 0 auto;
        background: #f5f5f7;
        min-height: 100vh;
      }
      h2 {
        text-align: center;
        color: #1d1d1f;
        font-size: clamp(1.2rem, 5vw, 1.5rem);
        margin-bottom: 16px;
      }
      textarea {
        width: 100%;
        height: 60px;
        font-size: 10px;
        margin: 8px 0;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        padding: 8px;
        resize: none;
        font-family: monospace;
      }
      button {
        padding: 12px 16px;
        margin: 4px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        background: #007aff;
        color: white;
      }
      button:active {
        transform: scale(0.97);
        opacity: 0.8;
      }
      .step {
        background: white;
        padding: 16px;
        margin: 12px 0;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .step h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #1d1d1f;
      }
      .step-num {
        display: inline-block;
        width: 24px;
        height: 24px;
        background: #007aff;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 24px;
        font-size: 12px;
        margin-right: 8px;
      }
      #log {
        background: white;
        padding: 12px;
        height: 180px;
        overflow-y: auto;
        margin-top: 12px;
        border-radius: 12px;
        font-size: 12px;
        line-height: 1.6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .msg-box {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      #msg {
        flex: 1;
        padding: 12px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
      }
      #msg:focus {
        border-color: #007aff;
      }
      .btn-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .btn-row button {
        flex: 1;
        min-width: 120px;
      }
      .success { color: #34c759; }
      .warning { color: #ff9500; }
      .error { color: #ff3b30; }
      
      @media (max-width: 400px) {
        body { padding: 12px; }
        .step { padding: 12px; }
        button { padding: 10px 12px; font-size: 13px; }
        textarea { height: 50px; font-size: 9px; }
        #log { height: 150px; font-size: 11px; }
      }
    </style>
  </head>
  <body>
    <h2>WebRTC è·¨è®¾å¤‡é€šä¿¡</h2>

    <div class="step">
      <h4><span class="step-num">1</span>å‘èµ·æ–¹ï¼šåˆ›å»ºè¿æ¥</h4>
      <div class="btn-row">
        <button onclick="createOffer()">åˆ›å»º Offer</button>
      </div>
      <textarea id="offer" placeholder="Offer ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œå¤åˆ¶ç»™æ¥æ”¶æ–¹"></textarea>
    </div>

    <div class="step">
      <h4><span class="step-num">2</span>æ¥æ”¶æ–¹ï¼šç²˜è´´ Offer åç‚¹å‡»</h4>
      <div class="btn-row">
        <button onclick="acceptOffer()">æ¥å—å¹¶ç”Ÿæˆ Answer</button>
      </div>
      <textarea id="answer" placeholder="Answer ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œå¤åˆ¶å›å‘èµ·æ–¹"></textarea>
    </div>

    <div class="step">
      <h4><span class="step-num">3</span>å‘èµ·æ–¹ï¼šç²˜è´´ Answer å®Œæˆè¿æ¥</h4>
      <div class="btn-row">
        <button onclick="acceptAnswer()">å®Œæˆè¿æ¥</button>
      </div>
    </div>

    <div class="msg-box">
      <input id="msg" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')send()" />
      <button onclick="send()">å‘é€</button>
    </div>

    <div id="log"></div>

    <script>
      let pc = null;
      let dc = null;

      function log(msg) {
        const d = document.getElementById("log");
        d.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
        d.scrollTop = d.scrollHeight;
        console.log(msg);
      }

      // ç¬¬ä¸€æ­¥ï¼šChrome åˆ›å»º Offer
      async function createOffer() {
        // è¯·æ±‚åª’ä½“æƒé™ä»¥è·å–çœŸå®IPï¼ˆä¸ä¼šçœŸçš„ä½¿ç”¨æ‘„åƒå¤´ï¼‰
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          stream.getTracks().forEach((t) => t.stop()); // ç«‹å³åœæ­¢
          log("âœ… å·²è·å–åª’ä½“æƒé™");
        } catch (e) {
          log("âš ï¸ æœªè·å–åª’ä½“æƒé™ï¼Œå¯èƒ½åªæœ‰mDNSå€™é€‰");
        }

        pc = new RTCPeerConnection();

        let candidateCount = 0;
        pc.onicecandidate = (e) => {
          if (e.candidate) {
            candidateCount++;
            const c = e.candidate.candidate;
            // æ˜¾ç¤ºå®Œæ•´å€™é€‰ä¿¡æ¯ï¼šIP:ç«¯å£ ç±»å‹
            const match = c.match(
              /candidate:\S+ \d+ \S+ \d+ (\S+) (\d+) typ (\S+)/
            );
            if (match) {
              log(
                `ğŸ§Š ICEå€™é€‰ #${candidateCount}: ${match[1]}:${match[2]} (${match[3]})`
              );
            } else {
              log(`ğŸ§Š ICEå€™é€‰ #${candidateCount}: ${c.substring(0, 60)}...`);
            }
          }
        };

        pc.onicegatheringstatechange = () => {
          log("ICEæ”¶é›†çŠ¶æ€: " + pc.iceGatheringState);
          if (pc.iceGatheringState === "complete") {
            document.getElementById("offer").value = JSON.stringify(
              pc.localDescription
            );
            log(`âœ… Offerå·²ç”Ÿæˆï¼ˆ${candidateCount}ä¸ªå€™é€‰ï¼‰ï¼Œè¯·å¤åˆ¶åˆ°Safari`);
          }
        };

        pc.oniceconnectionstatechange = () =>
          log("ICEçŠ¶æ€: " + pc.iceConnectionState);
        pc.onconnectionstatechange = () => {
          log("è¿æ¥çŠ¶æ€: " + pc.connectionState);
          if (pc.connectionState === "connected") {
            log("ğŸ‰ğŸ‰ğŸ‰ è¿æ¥æˆåŠŸï¼");
          }
        };

        dc = pc.createDataChannel("chat");
        dc.onopen = () => log("ğŸ‰ é€šé“å·²æ‰“å¼€ï¼å¯ä»¥å‘æ¶ˆæ¯äº†");
        dc.onmessage = (e) => log("ğŸ“© æ”¶åˆ°: " + e.data);

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        log("æ­£åœ¨æ”¶é›†ICEå€™é€‰...");
      }

      // ç¬¬äºŒæ­¥ï¼šSafari æ¥å— Offer å¹¶åˆ›å»º Answer
      async function acceptOffer() {
        const offerStr = document.getElementById("offer").value.trim();
        if (!offerStr) {
          alert("è¯·å…ˆç²˜è´´Offer");
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          stream.getTracks().forEach((t) => t.stop());
          log("âœ… å·²è·å–åª’ä½“æƒé™");
        } catch (e) {
          log("âš ï¸ æœªè·å–åª’ä½“æƒé™ï¼Œå¯èƒ½åªæœ‰mDNSå€™é€‰");
        }

        pc = new RTCPeerConnection();

        let candidateCount = 0;
        pc.onicecandidate = (e) => {
          if (e.candidate) {
            candidateCount++;
            const c = e.candidate.candidate;
            // æ˜¾ç¤ºå®Œæ•´å€™é€‰ä¿¡æ¯ï¼šIP:ç«¯å£ ç±»å‹
            const match = c.match(
              /candidate:\S+ \d+ \S+ \d+ (\S+) (\d+) typ (\S+)/
            );
            if (match) {
              log(
                `ğŸ§Š ICEå€™é€‰ #${candidateCount}: ${match[1]}:${match[2]} (${match[3]})`
              );
            } else {
              log(`ğŸ§Š ICEå€™é€‰ #${candidateCount}: ${c.substring(0, 60)}...`);
            }
          }
        };

        pc.onicegatheringstatechange = () => {
          log("ICEæ”¶é›†çŠ¶æ€: " + pc.iceGatheringState);
          if (pc.iceGatheringState === "complete") {
            document.getElementById("answer").value = JSON.stringify(
              pc.localDescription
            );
            log(`âœ… Answerå·²ç”Ÿæˆï¼ˆ${candidateCount}ä¸ªå€™é€‰ï¼‰ï¼Œè¯·å¤åˆ¶å›Chrome`);
          }
        };

        pc.oniceconnectionstatechange = () =>
          log("ICEçŠ¶æ€: " + pc.iceConnectionState);
        pc.onconnectionstatechange = () => {
          log("è¿æ¥çŠ¶æ€: " + pc.connectionState);
          if (pc.connectionState === "connected") {
            log("ğŸ‰ğŸ‰ğŸ‰ è¿æ¥æˆåŠŸï¼");
          }
        };

        pc.ondatachannel = (e) => {
          dc = e.channel;
          dc.onopen = () => log("ğŸ‰ é€šé“å·²æ‰“å¼€ï¼å¯ä»¥å‘æ¶ˆæ¯äº†");
          dc.onmessage = (e) => log("ğŸ“© æ”¶åˆ°: " + e.data);
        };

        await pc.setRemoteDescription(JSON.parse(offerStr));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        log("æ­£åœ¨æ”¶é›†ICEå€™é€‰...");
      }

      // ç¬¬ä¸‰æ­¥ï¼šChrome æ¥å— Answer
      async function acceptAnswer() {
        const answerStr = document.getElementById("answer").value.trim();
        if (!answerStr) {
          alert("è¯·å…ˆç²˜è´´Answer");
          return;
        }
        if (!pc) {
          alert("è¯·å…ˆåˆ›å»ºè¿æ¥");
          return;
        }

        await pc.setRemoteDescription(JSON.parse(answerStr));
        log("âœ… è¿æ¥å®Œæˆï¼Œç­‰å¾…é€šé“æ‰“å¼€...");
      }

      function send() {
        const msg = document.getElementById("msg").value.trim();
        if (!msg) return;
        if (!dc || dc.readyState !== "open") {
          alert("é€šé“æœªæ‰“å¼€");
          return;
        }
        dc.send(msg);
        log("ğŸ“¤ å‘é€: " + msg);
        document.getElementById("msg").value = "";
      }

      log("å‡†å¤‡å°±ç»ª");
    </script>
  </body>
</html>
